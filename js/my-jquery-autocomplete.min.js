
(function($,undef){var namespace="autocomplete",win=$(window),defaults={ajax:{url:document.URL,type:"POST",dataType:"json",data:{}},cb:{populate:undef,cast:undef,filter:undef,process:undef,preselect:undef,select:undef,unselect:undef,force:undef},width:"auto",offset:undef,delay:250,name:undef,minLength:1,cache:true,once:false,source:undef,match:true,prefix:true,splitChr:undef,autohide:false,loop:true,selectFirst:true,className:namespace},ua=navigator.userAgent.toLowerCase(),opera=ua.match(/opera/),msie=ua.match(/msie/);function clone(mixed){var result;if($.isArray(mixed)){result=[];$.each(mixed,function(i,value){result.push(value);});}else if(typeof mixed==="object"){result=$.extend(true,{},mixed);}else{result=mixed;}
return result;}
function splitData(data,splitChr){if(splitChr){return data.split(splitChr);}else{return data.split(/\r\n|\r|\n/);}}
function Autocomplete(element){var toComplete,toAutoHide,dropbox,options={},iHover=-1,current,keys=[],count=0,cache={},binded=false,scrolling=false,handlers={key:keyPressed,focusout:function(){if(!$(this).data(namespace+"-focus")){hide(true);}},dblclick:function(){if(!dropbox){updateToComplete(false);}},resize:function(){if(dropbox){relocate();}}};function getSource(source){if(typeof source==="function"){return getSource(source.call(element,element.val()));}else if(typeof source==="string"){return splitData(source,options.splitChr);}
return source;}
function bind(){if(!binded){element[opera?"keypress":"keydown"](handlers.key);element.focusout(handlers.focusout);element.dblclick(handlers.dblclick);binded=true;}}
function unbind(){if(binded){element.unbind(opera?"keypress":"keydown",handlers.key);element.unbind("focusout",handlers.focusout);element.unbind("dblclick",handlers.dblclick);binded=false;}}
function relocate(){var offset=element.offset(),optOffset=typeof options.offset==="function"?options.offset():options.offset;dropbox.offset({top:offset.top+(optOffset&&optOffset.top?optOffset.top:element.outerHeight()+1),left:offset.left+(optOffset&&optOffset.left?optOffset.left:0)});}
function updateToAutoHide(){if(!options.autohide){return;}
stopToAutoHide();toAutoHide=setTimeout(function(){hide(true);},options.autohide);}
function stopToAutoHide(){if(toAutoHide){clearTimeout(toAutoHide);toAutoHide=undef;}}
function updateToComplete(noWait){clearTimeout(toComplete);toComplete=setTimeout(complete,noWait?0:options.delay);}
function hoverize(i,visible){var li=dropbox?$("li",dropbox).eq(i):undef;if(li){li[(visible?"add":"remove")+"Class"]("hover");if(visible){scroll(li);}}}
function scroll(target){var top=dropbox.scrollTop(),height=dropbox.innerHeight(),eTop=target.position().top,eHeight=target.outerHeight();if(eTop<0){scrolling=true;dropbox.scrollTop(top+eTop);}else if(eTop+eHeight>height){scrolling=true;dropbox.scrollTop(top+eTop-height+eHeight);}}
function getPageUpDownItem(up){if(!dropbox){return false;}
var height=dropbox.innerHeight(),pageCount=0,next=iHover;$("li",dropbox).each(function(){var li=$(this);pageCount+=(li.position().top>=0)&&(li.position().top+li.outerHeight()<=height)?1:0;});if(iHover<0){return(up?count:pageCount)-1;}
next+=up?-pageCount:pageCount;next=Math.max(0,next);next=Math.min(next,count-1);if(options.loop&&(next===iHover)){next=next===0?count-1:0;}
return next;}
function keyPressed(e){var next,li,c=e.which;if(c===9){return;}
if(!dropbox&&(c!==27)&&(c!==13)){updateToComplete(false);}else if((c===38)||(c===40)){next=iHover+(c===38?-1:1);if(options.loop){if(next<0){next=count-1;}else if(next>count-1){next=0;}}
next=Math.max(0,next);next=Math.min(next,count-1);preselect(next);e.preventDefault();}else if((c===33)||(c===34)){next=getPageUpDownItem(c===33);if(next!==false){preselect(next);}
e.preventDefault();}else if(c===13){if(iHover!==-1){li=$("li",dropbox).eq(iHover);select(iHover,options.cb.cast?options.cb.cast(current[li.data("key")]):li.text());e.preventDefault();e.stopImmediatePropagation();}else{hide(true);if(c===13&&options.cb.force){options.cb.force.call(element);}}}else if(c===27){preselect(-1);hide(true);}else{updateToComplete(false);}}
function getData(){var data,name="value";if(options.cb.populate){data=$.extend(true,{},options.ajax.data,options.cb.populate.call(element));}else{data=$.extend(true,{},options.ajax.data);if(options.name&&options.name.length){name=options.name;}else if(element.attr("name")&&element.attr("name").length){name=element.attr("name");}else if(element.attr("id")&&element.attr("id").length){name=element.attr("id");}
data[name]=element.val();}
return data;}
function complete(){var value=element.val();if(options.minLength&&(options.minLength>value.length)){if(hide(true)){preselect(-1);}
return;}
if(options.source){completeSource();}else{completeAjax();}}
function matchFilter(data,cast){var val=element.val(),re=new RegExp((options.prefix?"^":"")+val.replace(/[\-\[\]{}()*+?.,\\\^\$\|#\s]/g,"\\$&"),"i"),result=[];if(!val.length){return data;}
$.each(data,function(key,value){if(re.test(value.data)){result.push(value);}});return result;}
function completeSource(){show(getSource(options.source),options.match);}
function completeAjax(){var settings,data,value=element.val();if(cache&&((options.once&&!$.isEmptyObject(cache))||(options.cache&&(typeof cache[value]!=="undefined")))){data=options.once?clone(cache):clone(cache[value]);if(options.cb.process){data=options.cb.process.call(element,data,options.once?"once":"cache");}
if(typeof data==="string"){data=splitData(data,options.splitChr);}
show(data,options.match);return;}
settings=$.extend(true,{},options.ajax);settings.success=function(data,textStatus,jqXHR){if(options.once){cache=clone(data);}else if(options.cache){cache[value]=clone(data);}
if(options.cb.process){data=options.cb.process.call(element,data,textStatus,jqXHR);}
if(typeof data==="string"){data=splitData(data,options.splitChr);}
show(data,options.match);};settings.data=getData();$.ajax(settings);}
function preselect(next){var key;updateToAutoHide();if(iHover===next){return;}
hoverize(iHover,false);iHover=next;hoverize(iHover,true);if(options.cb.preselect){if(iHover===-1){options.cb.preselect.call(element);}else{key=keys[iHover];options.cb.preselect.call(element,current[key],key,iHover);}}}
function select(i,value){var key=keys[i];stopToAutoHide();if(value!==undef){element.val(value);}
hide();element.focus();if(options.cb.select){options.cb.select.call(element,current[key],key,i);}}
function show(data,match){var position=element.position(),width=msie?element.outerWidth():element.width(),cast=options.cb.cast||function(s){return s;};hide();if(options.cb&&options.cb.filter){data=options.cb.filter(data);}
if(!data){return;}
if((typeof match==="undefined"&&options.filter)||match){data=matchFilter(data,cast);}
current=data;dropbox=$(document.createElement("ul")).addClass(options.className);dropbox.css({position:"absolute",left:position.left+"px",top:(position.top+element.outerHeight())+"px"});dropbox.scroll(function(){scrolling=false;});if(options.width==="auto"){dropbox.css(msie?"width":"minWidth",width+"px");}else if(options.width===false){dropbox.css({width:width+"px",overflow:"hidden"});}else{dropbox.css({width:typeof options.width==="function"?options.width():options.width,overflow:"hidden"});}
iHover=-1;count=0;keys=[];$.each(current,function(key,value){var li=$(document.createElement("li")),a=$(document.createElement("a")),i=count;var myactive=(cast(value).indexOf(': ')>0);a.click(function(event){event.stopPropagation();select(i,cast(value));});li.data("key",key);li.click(function(event){event.stopPropagation();select(i,cast(value));});if(myactive){li.hover(function(){if(!scrolling){preselect(i);}});}
dropbox.append(li.append(a.append(cast(value,true))));keys[i]=key;count+=1;});if(!count){dropbox.remove();return;}
dropbox.hover(function(){element.data(namespace+"-focus",true);stopToAutoHide();},function(){element.data(namespace+"-focus",false);updateToAutoHide();if(!element.is(":focus")){element.trigger("focusout");}});$("body").append(dropbox);win.on("resize",handlers.resize);relocate();if(msie){$.each(["min","max"],function(isMax,type){$.each(["Width","Height"],function(i,property){var v=parseInt(dropbox.css(type+property),10);if(!isNaN(v)&&((dropbox[property.toLowerCase()]()<v)^isMax)){dropbox.css(property.toLowerCase(),v+"px");}});});}
if(options.selectFirst){preselect(0);}
updateToAutoHide();}
function reverse(value){var result=undef;$("li",dropbox).each(function(i,li){if(result===undef&&$(li).text()===value){result=i;}});return result;}
function hide(checkReverse){if(dropbox){if(checkReverse){var value=element.val(),index=!value.length||(options.minLength&&(options.minLength>value.length))?undef:reverse(value);if(index!==undef){select(index);return false;}}
if(iHover>=0&&options.cb.unselect){options.cb.unselect.call(element);}
stopToAutoHide();dropbox.remove();win.off("resize",handlers.resize);dropbox=undef;iHover=-1;return true;}
return false;}
return{init:function(opts){options=$.extend(true,{},defaults,opts);if(typeof options.source==="string"){options.source=splitData(options.source,options.splitChr);}
element.attr("autocomplete","off");bind();},flushCache:function(){cache={};},enable:function(){bind();},disable:function(){unbind();preselect(-1);hide();},close:function(){hide();},trigger:function(){updateToComplete(true);},display:function(source,match){show(getSource(source),match);},matchon:function(){options.match=true;},matchoff:function(){options.match=false;},prefixon:function(){options.prefix=true;},prefixoff:function(){options.prefix=false;}};}
$.fn.autocomplete=function(p1,p2,p3){$.each(this,function(){var element=$(this),current=element.data(namespace);if(!current){current=new Autocomplete(element);element.data(namespace,current);}
if(typeof p1==="string"&&current.hasOwnProperty(p1)){current[p1](p2,p3);}else{current.init(p1);}});return this;};}(jQuery));